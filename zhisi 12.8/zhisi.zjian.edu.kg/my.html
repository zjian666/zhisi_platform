<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个人中心 - 智思平台</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="global.js"></script>
    <style>
        :root { --primary-color: #D32F2F; --bg-light: #f5f7fa; --white: #ffffff; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'PingFang SC', sans-serif; background-color: var(--bg-light); color: #333; }
        
        header { background: var(--white); height: 60px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
        .logo { font-weight: bold; color: var(--primary-color); font-size: 1.2rem; text-decoration: none; }
        
        .container { max-width: 1000px; margin: 40px auto; padding: 20px; } /* 加宽了容器 */
        
        .card { background: var(--white); border-radius: 10px; padding: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card-header { border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 20px; font-size: 1.2rem; font-weight: bold; color: var(--primary-color); }
        
        .info-row { margin-bottom: 20px; }
        .info-row label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        .form-control:disabled { background: #eee; }
        
        .btn-save { background: var(--primary-color); color: white; padding: 10px 25px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; }
        .btn-save:hover { background: #b71c1c; }

        /* 表格样式优化 */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        th, td { padding: 12px 8px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #fafafa; color: #666; font-weight: 600; }
        
        /* 按钮组 */
        .action-btns { display: flex; gap: 5px; }
        .btn-mini { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; cursor: pointer; border: 1px solid transparent; color: white; }
        .btn-edit { background-color: #1976D2; }
        .btn-reset { background-color: #FBC02D; color: #333; }
        .btn-del { background-color: #E53935; }
        .btn-disabled { background-color: #ccc; cursor: not-allowed; }

        /* 弹窗样式 */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal { background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; position: relative; }
        .close-modal { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; cursor: pointer; color: #999; }
    </style>
</head>
<body>
    <header><a href="index.html" class="logo"><i class="fas fa-chevron-left"></i> 返回首页</a></header>
    
    <div class="container">
        <div class="card">
            <h2 id="welcomeText">欢迎回来</h2>
            <p style="color: #666; margin-top: 5px;" id="roleText">身份加载中...</p>
        </div>

        <div id="userProfile" class="card" style="display:none;">
            <div class="card-header"><i class="fas fa-id-card"></i> 个人资料</div>
            <div class="info-row"><label>手机号</label><input type="text" id="pPhone" class="form-control" disabled></div>
            <div class="info-row"><label>姓名</label><input type="text" id="pName" class="form-control"></div>
            <div class="info-row"><label>学校/单位</label><input type="text" id="pSchool" class="form-control"></div>
            <div class="info-row"><label>地区</label><input type="text" id="pRegion" class="form-control"></div>
            <div class="info-row"><label>年级</label>
                <select id="pGrade" class="form-control">
                    <option value="七年级">七年级</option><option value="八年级">八年级</option><option value="九年级">九年级</option>
                </select>
            </div>
            <button class="btn-save" onclick="updateProfile()">保存修改</button>
        </div>

        <div id="adminPanel" class="card" style="display:none;">
            <div class="card-header"><i class="fas fa-users-cog"></i> 用户管理 (管理员)</div>
            <p style="color:#666; font-size:0.9rem; margin-bottom:10px;">提示：密码已加密存储无法查看，如忘记密码请点击“重置”，默认重置为 12345678</p>
            <div style="overflow-x: auto;">
                <table id="userTable">
                    <thead>
                        <tr>
                            <th>身份</th>
                            <th>姓名</th>
                            <th>手机号</th>
                            <th>学校</th>
                            <th>年级</th>
                            <th style="min-width: 180px;">操作</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="setupModal" class="modal-overlay">
        <div class="modal">
            <h3>完善信息</h3>
            <p style="text-align:center; color:#666; margin-bottom:20px;">首次登录请填写信息。</p>
            <div class="info-row"><label>姓名*</label><input type="text" id="mName" class="form-control"></div>
            <div class="info-row"><label>学校*</label><input type="text" id="mSchool" class="form-control"></div>
            <div class="info-row"><label>地区*</label><input type="text" id="mRegion" class="form-control"></div>
            <div class="info-row"><label>年级*</label><select id="mGrade" class="form-control"><option value="七年级">七年级</option><option value="八年级">八年级</option><option value="九年级">九年级</option></select></div>
            <button class="btn-save" onclick="completeSetup()">提交</button>
        </div>
    </div>

    <div id="adminEditModal" class="modal-overlay">
        <div class="modal">
            <span class="close-modal" onclick="closeEditModal()">&times;</span>
            <h3 style="margin-bottom:20px; color:var(--primary-color);">编辑用户资料</h3>
            <input type="hidden" id="editUserId">
            <div class="info-row"><label>手机号</label><input type="text" id="editPhone" class="form-control"></div>
            <div class="info-row"><label>姓名</label><input type="text" id="editName" class="form-control"></div>
            <div class="info-row"><label>学校</label><input type="text" id="editSchool" class="form-control"></div>
            <div class="info-row"><label>地区</label><input type="text" id="editRegion" class="form-control"></div>
            <div class="info-row"><label>年级</label>
                <select id="editGrade" class="form-control">
                    <option value="七年级">七年级</option><option value="八年级">八年级</option><option value="九年级">九年级</option>
                </select>
            </div>
            <button class="btn-save" onclick="submitAdminEdit()">保存更改</button>
        </div>
    </div>

    <script>
        const user = getCurrentUser();
        if(!user) window.location.href = 'login.html';

        window.onload = function() {
            document.getElementById('welcomeText').innerText = `欢迎回来，${user.name}`;
            
            if (user.role === 'admin') {
                document.getElementById('roleText').innerText = '当前身份：系统管理员';
                document.getElementById('adminPanel').style.display = 'block';
                loadAdminTable();
            } else {
                document.getElementById('roleText').innerText = user.role === 'teacher' ? '当前身份：教师' : '当前身份：学生';
                if (!user.is_setup) {
                    document.getElementById('setupModal').style.display = 'flex';
                } else {
                    document.getElementById('userProfile').style.display = 'block';
                    fillProfile();
                }
            }
        }

        // --- 普通用户逻辑 ---
        async function completeSetup() { /* ...同之前的逻辑... */ 
            const updateData = { id: user.id, name: document.getElementById('mName').value, school: document.getElementById('mSchool').value, region: document.getElementById('mRegion').value, grade: document.getElementById('mGrade').value };
            if(!updateData.name || !updateData.school) return alert('请填写完整');
            await syncUpdate(updateData);
        }

        async function updateProfile() {
            const updateData = { id: user.id, name: document.getElementById('pName').value, school: document.getElementById('pSchool').value, region: document.getElementById('pRegion').value, grade: document.getElementById('pGrade').value };
            await syncUpdate(updateData);
        }

        async function syncUpdate(data) {
            try {
                const res = await fetch(API_BASE_URL + '/update-profile', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                if (res.ok) {
                    const newUser = { ...user, ...data, is_setup: 1 };
                    localStorage.setItem('zhisi_current_user', JSON.stringify(newUser));
                    alert('保存成功');
                    window.location.reload();
                } else alert('保存失败');
            } catch(e) { alert('网络错误'); }
        }

        function fillProfile() {
            document.getElementById('pPhone').value = user.phone;
            document.getElementById('pName').value = user.name;
            document.getElementById('pSchool').value = user.school || '';
            document.getElementById('pRegion').value = user.region || '';
            document.getElementById('pGrade').value = user.grade || '七年级';
        }

        // --- 管理员逻辑 (核心修改) ---

        async function loadAdminTable() {
            try {
                const res = await fetch(API_BASE_URL + '/users');
                const users = await res.json();
                const tbody = document.querySelector('#userTable tbody');
                tbody.innerHTML = '';
                
                users.forEach(u => {
                    // 如果是管理员自己，不显示操作按钮
                    const isAdmin = u.role === 'admin';
                    
                    let actionHtml = '';
                    if (isAdmin) {
                        actionHtml = '<span style="color:#999; font-size:0.8rem;">系统保护</span>';
                    } else {
                        // 将用户数据转为字符串存入 data 属性，方便点击编辑时读取
                        const userString = encodeURIComponent(JSON.stringify(u));
                        actionHtml = `
                            <div class="action-btns">
                                <button class="btn-mini btn-edit" onclick="openEditModal('${userString}')">编辑</button>
                                <button class="btn-mini btn-reset" onclick="resetPass(${u.id}, '${u.name}')">重置密码</button>
                                <button class="btn-mini btn-del" onclick="delUser(${u.id})">删除</button>
                            </div>
                        `;
                    }

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${u.role === 'teacher' ? '教师' : (u.role === 'student' ? '学生' : '管理员')}</td>
                        <td>${u.name}</td>
                        <td>${u.phone}</td>
                        <td>${u.school || '-'}</td>
                        <td>${u.grade || '-'}</td>
                        <td>${actionHtml}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                console.error(e);
                alert('无法获取用户列表');
            }
        }

        // 1. 打开编辑弹窗
        function openEditModal(userStr) {
            const u = JSON.parse(decodeURIComponent(userStr));
            document.getElementById('editUserId').value = u.id;
            document.getElementById('editPhone').value = u.phone;
            document.getElementById('editName').value = u.name;
            document.getElementById('editSchool').value = u.school || '';
            document.getElementById('editRegion').value = u.region || '';
            document.getElementById('editGrade').value = u.grade || '七年级';
            
            document.getElementById('adminEditModal').style.display = 'flex';
        }

        function closeEditModal() {
            document.getElementById('adminEditModal').style.display = 'none';
        }

        // 2. 提交编辑
        async function submitAdminEdit() {
            const data = {
                id: document.getElementById('editUserId').value,
                phone: document.getElementById('editPhone').value,
                name: document.getElementById('editName').value,
                school: document.getElementById('editSchool').value,
                region: document.getElementById('editRegion').value,
                grade: document.getElementById('editGrade').value
            };

            try {
                const res = await fetch(API_BASE_URL + '/admin/edit-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if(res.ok) {
                    alert('修改成功');
                    closeEditModal();
                    loadAdminTable(); // 刷新表格
                } else {
                    alert(result.msg);
                }
            } catch(e) { alert('操作失败'); }
        }

        // 3. 重置密码
        async function resetPass(id, name) {
            if(confirm(`确定要将用户 [${name}] 的密码重置为 12345678 吗？`)) {
                try {
                    const res = await fetch(API_BASE_URL + '/admin/reset-pass', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id })
                    });
                    const result = await res.json();
                    alert(result.msg);
                } catch(e) { alert('重置失败'); }
            }
        }

        // 4. 删除用户
        async function delUser(id) {
            if(confirm('确定要永久删除该用户吗？此操作不可恢复！')) {
                try {
                    const res = await fetch(API_BASE_URL + '/delete-user', { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ id }) 
                    });
                    const data = await res.json();
                    if(res.ok) {
                        alert('已删除');
                        loadAdminTable();
                    } else {
                        alert(data.msg); // 会弹出“无法删除管理员”
                    }
                } catch(e) { alert('删除失败'); }
            }
        }
    </script>
</body>
</html>