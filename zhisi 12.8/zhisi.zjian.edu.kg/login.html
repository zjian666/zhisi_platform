<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>登录 / 注册 - 智思平台</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="global.js"></script> <style>
        :root { --primary-color: #D32F2F; --white: #ffffff; }
        body { font-family: 'PingFang SC', sans-serif; background: linear-gradient(135deg, #c62828 0%, #ef5350 100%); height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; margin: 0;}
        .auth-container { background: var(--white); width: 100%; max-width: 450px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; }
        .auth-header { text-align: center; padding: 30px 30px 0; }
        .auth-header h2 { color: var(--primary-color); font-size: 1.8rem; margin-bottom: 5px; }
        .tabs { display: flex; margin-top: 25px; border-bottom: 1px solid #eee; }
        .tab-btn { flex: 1; padding: 15px; text-align: center; cursor: pointer; font-weight: bold; color: #666; transition: 0.3s; }
        .tab-btn.active { color: var(--primary-color); border-bottom: 3px solid var(--primary-color); }
        .form-content { padding: 30px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #333; font-weight: 500; }
        .form-control { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; box-sizing: border-box; }
        .btn-submit { width: 100%; padding: 12px; background: var(--primary-color); color: white; border: none; border-radius: 6px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .hidden { display: none; }
        .role-select { display: flex; gap: 15px; }
        .role-option { flex: 1; border: 1px solid #ddd; padding: 10px; text-align: center; border-radius: 6px; cursor: pointer; color: #666; }
        .role-option.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }
        .back-home { text-align: center; margin-top: 15px; font-size: 0.9rem; }
        .back-home a { color: #666; text-decoration: none; }
    </style>
</head>
<body>
    <div class="auth-container">
        <div class="auth-header"><h2>智思平台</h2><p>初中思政教育一站式服务</p></div>
        <div class="tabs">
            <div class="tab-btn active" onclick="switchTab('login')">登录</div>
            <div class="tab-btn" onclick="switchTab('register')">注册</div>
        </div>

        <form id="loginForm" class="form-content" onsubmit="handleLogin(event)">
            <div class="form-group"><label>账号 / 手机号</label><input type="text" id="loginInput" class="form-control" required></div>
            <div class="form-group"><label>密码</label><input type="password" id="loginPass" class="form-control" required></div>
            <button type="submit" class="btn-submit">立即登录</button>
            <div class="back-home"><a href="index.html">返回首页</a></div>
        </form>

        <form id="registerForm" class="form-content hidden" onsubmit="handleRegister(event)">
            <div class="form-group"><label>选择身份</label>
                <div class="role-select">
                    <div class="role-option active" onclick="selectRole('teacher', this)">教师</div>
                    <div class="role-option" onclick="selectRole('student', this)">学生</div>
                </div>
                <input type="hidden" id="regRole" value="teacher">
            </div>
            <div class="form-group"><label>手机号</label><input type="tel" id="regPhone" class="form-control" maxlength="11" required></div>
            <div class="form-group"><label>密码 (不少于8位)</label><input type="password" id="regPass" class="form-control" minlength="8" required></div>
            <button type="submit" class="btn-submit">注册账号</button>
        </form>
    </div>

    <script>
        function switchTab(type) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            if (type === 'login') {
                document.querySelectorAll('.tab-btn')[0].classList.add('active');
                document.getElementById('loginForm').classList.remove('hidden');
                document.getElementById('registerForm').classList.add('hidden');
            } else {
                document.querySelectorAll('.tab-btn')[1].classList.add('active');
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('registerForm').classList.remove('hidden');
            }
        }

        function selectRole(role, btn) {
            document.querySelectorAll('.role-option').forEach(r => r.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('regRole').value = role;
        }

        async function handleLogin(e) {
            e.preventDefault();
            const phone = document.getElementById('loginInput').value;
            const password = document.getElementById('loginPass').value;

            try {
                const res = await fetch(API_BASE_URL + '/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone, password })
                });
                const data = await res.json();
                if (res.ok) {
                    localStorage.setItem('zhisi_current_user', JSON.stringify(data.user));
                    alert('登录成功！');
                    window.location.href = 'my.html';
                } else {
                    alert(data.msg);
                }
            } catch (err) { alert('服务器连接失败，请检查网络或联系管理员'); }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const role = document.getElementById('regRole').value;
            const phone = document.getElementById('regPhone').value;
            const password = document.getElementById('regPass').value;

            if (!/^1[3-9]\d{9}$/.test(phone)) return alert("请输入有效的11位手机号码！");
            if (password.length < 8) return alert("密码长度不能少于8位！");

            try {
                const res = await fetch(API_BASE_URL + '/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone, password, role })
                });
                const data = await res.json();
                if (res.ok) {
                    alert('注册成功，请登录！');
                    switchTab('login');
                } else {
                    alert(data.msg);
                }
            } catch (err) { alert('注册失败'); }
        }
    </script>
</body>
</html>